sudo: required
dist: trusty

language: java
services:
  - docker

env:
  global:
    - secure: "d7jJmEFMcdJv7UiGhvrOJF/1zOjLpC1vaMrNtOWXoM6DmnC+Jmg9wdeyex6eUziBpVvbZKOc0mJ9Kk2ITKNgN1hDWaY+RuoDKY2+OfPRyiLQbFaKL6xc5gKVlCFKrP8//0XNXhzkKDeOogp8mx+cA0G+wuN7H6NhTC7hYUxANpQJ2P2WzCH7HYaqMP6VF2kq2jEipAmlwVWUgi+wSG9+SW+8DU1Jus9mJygshC7GzE9Ym+Asy0Rzi06BcVUl29/dP9DpA0Jq59bM8nAyIth9mRtS2MUsycJM6FOt4NppzOzdQygRd8mP7mSPv2KeOT7brFdMiRi+2CHcuNA8cZzBZgiJmA9yNt1BNObu1mTTJY3mYefZgvnl/Duz4ggFr79T4zqtt93Eu3K1O0EKsSWrugA3ZVO6sRI7TLeSjaXv1idO4iXJ7DoLgks2PwtuKke20qRDzK7g5LdqmyKA+TG2vSsUvGzeUOfLpvHCi9y+p9wLlpULSxsTRFf2EiHisBGZn/Vs6to6JGDVoJQDpD0bTHux/Kmmq/ZS+LDcfgPLUdgXltoTTTsgT97iocVCGXH0+Dz6dEoptVTXyQOGGZXD3KUbh5KcyTi4Gmiowt5z3OvxCYxmVyD/tpzj0cMwPTh4x0aEoyHNC/yUmLraSLbNxYKlc7OSKfh9WDDk5L7RwPM="

# manage the caches here https://travis-ci.org/hawkular/hawkular-services/caches
cache:
  directories:
  - $HOME/.m2/repository

jdk:
- oraclejdk8

notifications:
  irc:
    channels:
    - chat.freenode.net#hawkular
    on_success: change

install:
- bash .travis.install.maven.sh "3.3.9" "${HOME}/mvn-home"
- export M2_HOME=${HOME}/mvn-home
- export PATH=${HOME}/mvn-home/bin:${PATH}
- mvn -version -B
# unshallow is needed by license-maven-plugin
- git fetch origin --unshallow || true

script:
- mvn -s .travis.maven.settings.xml verify -Pitest -Dfailsafe.useFile=false | grep -vF "[INFO] Downloading:" | grep
  -vF "[INFO] Downloaded:"; test ${PIPESTATUS[0]} -eq 0

after_success:
- bash .travis.hawkular-client.ruby.sh

before_cache:
# Clean the cached directories once their size exceeds the space left on the partition.
# This is important because Travis zips the chached directories to a temporary file on the same partition.
# Note that while we consider the summed size of all cached dirs, we remove only those ones that tend to grow over time
- CACHED_DIRECTORIES=("$HOME/.m2/repository")
- availBytes=$(df -P . | tail -1 | awk '{print $4}')
- cachedBytes=$(du -cs "${CACHED_DIRECTORIES[@]}" | tail -1 | awk '{print $1}')
- echo "Checking if the size of directories to cache ${cachedBytes} Bytes exceeds the free space ${availBytes} Bytes left on the current partition"
- if [ "${cachedBytes}" -gt "${availBytes}" ] ; then
    echo "Cleaning the cached dirs (${cachedBytes} Bytes) because their size exceeds the free space (${availBytes} Bytes) left on the current partition"
    rm -Rf "$HOME/.m2"
  fi
